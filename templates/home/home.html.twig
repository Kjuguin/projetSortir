{% extends 'layout.html.twig' %}

{% block title %}Sorties entr'Eni{% endblock %}

{% block body %}
    {% for message in app.flashes('danger') %}
        <div class="alert alert-danger">
            {{ message }}
        </div>
    {% endfor %}

    <!-- SECTION 1 : Recherche et filtres des sorties -->
    <header class="gradient-section">
        <nav class="nav-header">
            <div class="logo-header">
                <a href="{{ path('home') }}">
                    <img class="logo-img" src="{{ asset("img/logo.png") }}">
                    <h1 class="site-title">SORTIES ENTR'ENI</h1>
                </a>
            </div>
            <ul class="nav-menu">
                {#                <li><a href="#">Villes</a></li>#}
                {#                <li><a href="#">Sites</a></li>#}
                <li><a href="{{ path('home') }}">Accueil</a></li>
                <li><a href="#">Profil</a></li>
                <li><a href="{{ path('app_logout') }}">Déconnexion</a></li>
            </ul>
        </nav>

        <section class="section-filtre">
            <div class="container-home">
                <form action="{{ path('home',{'recherche':'recherche'} ) }}" method="get">

                    <!-- filtres inputs -->
                    <div class="filtre-bloc-left">
                        <!-- 1ere ligne d'inputs -->
                        <div class="filtre-ligne-1">
                            <div class="bloc-field bf-1">
                                <label for="site">Site</label>
                                <select class="input-home" name="site" id="site">
                                    <option value="" selected>Tous les sites</option>
                                    {% for site in sites %}

                                        <option value="{{ site.id }}"> {{ site.nomSite }}</option>

                                    {% endfor %}
                                </select>
                            </div>
                            <div class="bloc-field bf-2">
                                <label for="nom">Le nom contient</label>

                                <input class="input-home" type="search" name="nom" id="nom">
                            </div>
                        </div>

                        <div class="clear"></div>

                        <!-- 2eme ligne d'inputs -->
                        <div class="filtre-ligne-2">
                            <div class="bloc-field bf-3">
                                <label for="date-debut">Début</label>
                                <input class="input-home" type="date" name="date-debut" id="date-debut">
                            </div>
                            <div class="bloc-field bf-4">
                                <label for="date-fin">Fin</label>
                                <input class="input-home" type="date" name="date-fin" id="date-fin">

                            </div>
                        </div>

                        <div class="clear"></div>


                        <!-- filtres checkboxes -->
                        <div class="bf-checkboxes">
                            <div class="check">
                                <input type="checkbox" id="organisateur" name="filtre1" value="filtre1">
                                <label for="filtre1">Sorties dont je suis l'organisateur.rice</label>
                            </div>

                            <div class="check">
                                <input type="checkbox" id="inscrit" name="filtre2" value="filtre2">
                                <label for="filtre2">Sorties auxquelles je suis inscrit.e</label>
                            </div>

                            <div class="check">
                                <input type="checkbox" id="non-inscrit" name="filtre3" value="filtre3">
                                <label for="filtre3">Sorties auxquelles je ne suis pas inscrit.e</label>
                            </div>

                            <div class="check">
                                <input type="checkbox" id="sorties-passees" name="filtre4" value="filtre4">
                                <label for="filtre4">Sorties passées</label>

                            </div>
                        </div>
                    </div>

                    <!-- bouton recherche -->
                    <div>
                        <input type="submit" value="Rechercher">
                    </div>
                </form>
            </div>

            <!-- image background: clouds + city -->
            <div class="background-img">
                <img src="{{ asset('img/clouds-city.png') }}" alt="clouds-background">
            </div>
        </section>

    </header>

    <!-- SECTION 2 : Affichage du tableau des sorties -->
    <div class="container-fluid">
        <div class="table-responsive-sm">
            {% if(sorties !=null) %}
                <table id="table-sortie" data-toggle="table" class="table table-bordered table-orderable table-striped">
                    <thead class="thead-light">
                    <tr class="active">
                        <th scope="col" data-field="nom" data-sortable="true">Nom</th>
                        <th scope="col" data-field="date-sortie" data-sortable="true">Date</th>
                        <th scope="col" data-field="cloture" data-sortable="true">Clôture</th>
                        <th scope="col" data-field="places" data-sortable="true">Places</th>
                        <th scope="col" data-field="etat" data-sortable="true">Etat</th>
                        <th scope="col" data-field="inscrit" data-sortable="true">Inscrit</th>
                        <th scope="col" data-field="organisateur" data-sortable="true">Organisateur</th>
                        <th scope="col" data-field="action" data-sortable="true">Action</th>
                    </tr>
                    </thead>
                    <tbody id="tbody">

                    {% for sortie in sorties %}
                        <tr>
                            <td>{{ sortie.nom }}</td>
                            <td>{{ sortie.dateDebut | date('d/m/Y H:i') }}</td>
                            <td>{{ sortie.dateCloture | date('d/m/Y') }}</td>
                            <td>{{ sortie.noInscriptions.count }} / {{ sortie.nbInscriptionMax }}</td>
                            <td>{{ sortie.noEtat.libelle }}</td>
                            <td>
                                {% if app.user %}
                                    {% for inscrit in sortie.noInscriptions %}
                                        {% if inscrit.noUser.id == app.user.id %}
                                            <p>Oui</p>
                                        {% endif %}
                                    {% endfor %}
                                {% endif %}
                            </td>
                            <td>
                                <a href="{{ path('utilisateur_afficherProfil',{'id':sortie.noOrganisateur.id}) }}">{{ sortie.noOrganisateur.pseudo }}</a>
                            </td>
                            {#                            <td><a href="{{ path('sortie_afficherSortie',{'id':sortie.id}) }}">Afficher</a> - modifier</td>#}
                            <td>
                                {% set test = 0 %}

                                <!-- En création -->
                                {% if sortie.noEtat.libelle is same as ("En création") %}
                                    <a href="#">Modifier</a> - <a href="#">Publier</a>

                                    <!-- En cours -->
                                {% elseif  sortie.noEtat.libelle is same as ("En cours") %}
                                    <a href="{{ path('sortie_afficherSortie',{'id':sortie.id}) }}">Afficher</a>

                                    <!-- cas ouvert et fermé -->
                                {% else %}
                                    <a href="{{ path('sortie_afficherSortie',{'id':sortie.id}) }}">Afficher</a>


                                    <!-- cas fermé -->
                                    {% if sortie.noEtat.libelle is same as ('Fermé') %}

                                        {% for inscrit in sortie.noInscriptions %}

                                            <!-- fermé et inscrit -->
                                            {% if inscrit.noUser.id is same as (app.user.id) %}
                                                - <a href="#">Se désister</a>
                                            {% endif %}

                                            <!-- fermé et non inscrit (se passe rien) -->

                                        {% endfor %}
                                        <!-- cas ouvert -->
                                    {% elseif sortie.noEtat.libelle is same as ('Ouvert') %}

                                        {% if sortie.noInscriptions.count is same as (0) %}
                                            - <a href="{{ path('inscription',{'id':sortie.id}) }}">S'inscrire</a>
                                            {% if sortie.noOrganisateur.id is same as (app.user.id) %}
                                                - <a href="#">Annuler</a>
                                            {% endif %}
                                        {% else %}

                                            {% for inscrit in sortie.noInscriptions %}

                                                {% if inscrit.noUser.id != app.user.id %}

                                                    {% set test = test + 1 %}

                                                {% endif %}
                                            {% endfor %}

                                            {% if test == sortie.noInscriptions.count %}
                                                <!-- ouvert et non inscrit -->

                                                - <a href="{{ path('inscription',{'id':sortie.id}) }}">S'inscrire</a>

                                                <!-- ouvert, non inscrit et organisateur -->
                                                {% if sortie.noOrganisateur.id is same as (app.user.id) %}
                                                    - <a href="#">Annuler</a>
                                                {% endif %}
                                            {% else %}
                                                <!-- ouvert et inscrit -->
                                                - <a href="#">Se désister</a>

                                                <!-- ouvert, inscrit et organisateur -->
                                                {% if sortie.noOrganisateur.id is same as (app.user.id) %}
                                                    - <a href="#">Annuler</a>
                                                {% endif %}
                                            {% endif %}
                                        {% endif %}
                                    {% endif %}
                                {% endif %}
                            </td>
                        </tr>
                    {% endfor %}
                    </tbody>
                </table>
            {% endif %}
        </div>
    </div>
{% endblock %}

{% block javascripts %}
    <script>
        $recherche = function (data) {
            var $id = data['id'];
            $.each(data['sorties'], function (key, val) {
                    if (!(val['noEtat']['libelle'] === 'En création' && val['noOrganisateur']['id'] !== $id)) {


                        var $present = '';
                        var $pathProfil = "/utilisateur/afficherProfil/" + val['noOrganisateur']['id'];
                        var $dateCloture = new Date(val['dateCloture']);
                        var $outputCloture = $dateCloture.toLocaleString('en-GB', {
                            year: 'numeric',
                            month: '2-digit',
                            day: '2-digit'
                        });
                        var $dateDebut = new Date(val['dateDebut']);
                        var $outputDebut = $dateDebut.toLocaleString('en-GB', {
                            year: 'numeric',
                            month: '2-digit',
                            day: '2-digit',
                            hour: '2-digit',
                            minute: '2-digit'
                        });
                        var $noOrga = val['noOrganisateur']['id'];
                        var $action = '';

                        var pathOrga = "{{ path('utilisateur_afficherProfil',{'id':'%id%'}) }}";
                        pathOrga = pathOrga.replace("%25id%25", val['noOrganisateur']['id']);

                        var pathAff = "{{ path('sortie_afficherSortie',{'id':'%id2%'}) }}";
                        pathAff = pathAff.replace("%25id2%25", val['id']);

                        var pathInsc = "{{ path('inscription',{'id':'%id3%'}) }}";
                        pathInsc = pathInsc.replace("%25id3%25", val['id']);

                        {#var pathAnn = "{{ path('sortie_afficherSortie',{'id':'%id2%'}) }}";#}
                        {#pathAnn = pathAnn.replace("%25id2%25", val['id']);#}

                        {#var pathDesi = "{{ path('sortie_afficherSortie',{'id':'%id2%'}) }}";#}
                        {#pathDesi = pathDesi.replace("%25id2%25", val['id']);#}

                        {#var pathMod = "{{ path('sortie_afficherSortie',{'id':'%id2%'}) }}";#}
                        {#pathMod = pathMod.replace("%25id2%25", val['id']);#}

                        $.each(val['noInscriptions'], function (k, v) {
                            if ($id === v['noUser']['id']) {
                                $present = "Oui";
                            }
                        });

                        if (val['noEtat']['libelle'] === 'En création') {
                            $action = '<a href="#">Modifier</a> - <a href="#">Publier</a>'
                        } else if (val['noEtat']['libelle'] === 'En cours' || val['noEtat']['libelle'] === 'Terminer') {
                            $action = '<a href="' + pathAff +'">Afficher</a>'
                        } else {
                            $action = '<a href="' + pathAff +'">Afficher</a>'
                            if (val['noEtat']['libelle'] === 'Clôturer') {
                                if ($present === "Oui") {
                                    $action = $action + ' - ' + '<a href="#">Se désister</a>'
                                }
                            } else {
                                if (val['noInscriptions'].length === 0) {
                                    $action = $action + ' - ' + '<a href="'+ pathInsc + '">S\'inscrire</a>'
                                    // if (val['noOrganisateur']['id'] === $id) {
                                    //     $action = $action + ' - ' + '<a href=#">Annuler</a>'
                                    // }
                                } else if ($present === "Oui") {
                                    $action = $action + ' - ' + '<a href="#">Se désister</a>'
                                    // if (val['noOrganisateur']['id'] === $id) {
                                    //     $action = $action + ' - ' + '<a href=#">Annuler</a>'
                                    // }
                                } else {
                                    $action = $action + ' - ' + '<a href="' + pathInsc + '">S\'inscrire</a>'
                                    // if (val['noOrganisateur']['id'] === $id) {
                                    //     $action = $action + ' - ' + '<a href=#">Annuler</a>'
                                    // }
                                }
                            }
                            if (val['noOrganisateur']['id'] === $id) {
                                $action = $action + ' - ' + '<a href=#">Annuler</a>'
                            }
                        }

                        $('#tbody').append(
                            '<tr><td> ' + val['nom'] + '</td>' +
                            '<td>' + $outputDebut + '</td>' +
                            '<td> ' + $outputCloture + '</td>' +
                            '<td> ' + val['noInscriptions'].length + ' / ' + val['nbInscriptionMax'] + ' </td>' +
                            '<td>' + val['noEtat']['libelle'] + '</td>' +
                            '<td>' + $present + ' </td>' +
                            '<td> <a href = "' + pathOrga + '" >' + val['noOrganisateur']['pseudo'] + '</a></td>' +
                            '<td>' + $action + '</td>' + '</tr>'
                        );
                    }
                }
            );
        };
    </script>
{% endblock %}